16.11.2020

Задание

Реализовать под Windows руткит режима ядра и программу управления. Вся руткит-функциональность должна быть реализована в драйвере. Программа должна получать команды от пользователя по сети, через некоторый интерфейс передавать их драйверу и отдавать пользователю по сети результат.


n - номер студента в списке (ориентироваться на список с оценками). # 14
a=11
b=13


Базовая функциональность (к сдаче не принимаются задания с функциональностью меньше базовой).
15 баллов + баллы за выбранные задачи.

Вся реализуемая функциональность должна поддерживаться для 32-х разрядных ОС Windows XP, Windows 7, Windows 10 без перекомпиляции (т.е. во время исполнения необходимо определять версию системы и подстраиваться под неё).
Программа осуществляет загрузку и выгрузку драйвера. Для взаимодействия программы с драйвером перехватывать в драйвере системный вызов с номером 317*n%200 (подменять адрес в таблице системных вызовов). Программа должна вызывать этот системный вызов, передав в некотором аргументе предопределённое значение, по которому драйвер поймет, что это не обычный вызов системного вызова, а запрос от управляющей программы. В остальных параметрах программа может передавать аргументы для команды (в зависимости от реализиуемого интерфейса управления). Любой интерфейс управления можно организовать, задействуя два аргумента перехваченного системного вызова: в одном передаётся предопределённое значение, во втором - указатель на структуру с описанием команды. Если вдруг у системного вызова недостаточное количество аргументов, то можно увиличить число аргументов для этого вызова в таблице системных вызовов. # 38
Вся реализуемая функциональность должна настраиваться через интерфейс управления без количественных ограничений (т.е. не должно, к примеру, быть ограничения на количество скрываемых процессов).
При выгрузке драйвер должен корректно завершать свою работу, возвращая систему к первоначальному состоянию.
Руткит должен корректно работать под Driver Verifier.

Ниже представлены 4 вида задач. Для каждого вида перечислены конкретные задачи и способы перехвата. Необходимо выбрать от 2 до 4 задач (не больше одной из каждого вида) и соответствующий им способ перехвата. Доступные для выбора задача и способ перехвата для i-го (i от 0 до 3) вида определяется следующим образом.
Пусть N - число задач этого вида, M - число способов перехвата для этого вида.
Задача - (a*n+b*i)%N.
Способ перехвата - (a*n+b*i)%M.
За каждую задачу 5 баллов.

Виды задач:
0. Модификация списка процессов, возвращаемого системным вызовом ZwQuerySystemInformation
Задачи:
	0) Cкрытие процесса (по PID'у и по имени).
	1) Добавление в список (несуществующего) процесса с указанными пользователем именем и PID'ом.
#	2) Изменение у указанного (по PID'у и по имени) процесса имени на указанное пользователем.
	3) Вместо оригинального списка процессов возвращать список процессов с указанными пользователем PID'ами и именами.
Способы перехвата:	
#	0) Подмена адреса в таблице системных вызовов.
	1) Сплайсинг системного вызова.
1. Модификация списка сетевых соединений, возвращаемого сетевым драйвером через системный вызов ZwDeviceIoControlFile.
Задачи:
	0) Скрыть сетевое соединение (по номеру локального порта, по номеру удаленного порта, по номерам локального и удаленного портов).
	1) Добавить в список сетевое соединение с указанными пользователем данными.
	2) Изменить у указанного сетевого соединения (по номеру локального порта, по номеру удаленного порта, по номерам локального и удаленного портов) локальные и удалённые адреса и порты на указанные пользователем.
#	3) Вместо оригинального списка сетевых соединений возвращать список с указанными пользователем данными.
Способы перехвата:
	0) Подмена адреса в таблице системных вызовов.
	1) Сплайсинг системного вызова.
	2) Подмена адреса в таблице IRP-обработчиков сетевого драйвера (зависит от версии системы).
#	3) Сплайсинг IRP-обработчика сетевого драйвера.
2. Модификация списка файлов, возвращаемого системным вызовом ZwQueryDirectoryFile.
Задачи:
#	0) Скрыть файл (по имени, по абсолютному NT-пути).
	1) Добавить в список для указанной директории файл с указанным именем.
	2) Изменить в списке для указанной директории имя файла.
	3) Вместо оригинального списка файлов для указанной директории возвращать список с указанными пользователем данными.
Способы перехвата:
#	0) Подмена адреса в таблице системных вызовов.
	1) Сплайсинг системного вызова.
	2) Подмена адреса в таблице IRP-обработчиков драйвера файловой системы (зависит от версии системы).
	3) Сплайсинг IRP-обработчика драйвера файловой системы.
3. Модификация списка ключей реестра, возвращаемого системным вызовом ZwEnumerateKey.
Задачи:
	0) Скрыть ключ реестра (по имени, по пути).
	1) Добавить в список для указанного ключа подключ с указанным именем.
#	2) Изменить в списке для указанного ключа имя подключа.
	3) Вместо оригинального списка подключей для указанного ключа возвращать список с указанными данными.
Способы перехвата:
#	0) Подмена адреса в таблице системных вызовов.
	1) Сплайсинг системного вызова.



Дополнительные задания.
Выбрать не более двух дополнительных заданий.

1. Подмена http-трафика: внедрение js-кода.
Простое внедрение - 3 балла, до 15 баллов за универсальный алгоритм с пересборкой сетевых пакетов.

2. Скрывать указанный процесс путём удаления его из всех списков и таблиц: списка процессов, списка таблиц директорий, списка объектов в объекте типа, таблицы (хендлов) идентификаторов процессов и потоков.
5 баллов.

3. Изменять права доступа указанного процесса на права указанного пользователя.
3 балла.

4. Перехватывать запросы на чтение к драйверу клавиатуры. Внедрять в поток нажатых клавиш указанные пользователем последовательности и комбинации клавиш. Продемонстрировать с помощью этого механизма выполнение команд по скачиванию и запуску некоторого исполняемого файла.
5 баллов.

5. Все перехваты осуществлять максимально незаметно. Осуществлять скрытие перехватов и скрытий от антируткитов режима ядра.
До 20 баллов.

6. Для загрузки драйвера заразить какой-нибудь системный загружаемый драйвер.
20 баллов.

7. Сетевое взаимодействие через NDIS, т.е. самостоятельная реализация стека TCP/IP.
30 баллов.

8. Реализация загрузки руткита с помощью буткита.
30 баллов.

9. Реализация загрузки руткита с помощью биоскита.
50 баллов.

10. Реализация руткита в виде вирткита с использованием аппаратной виртуализации.
70 баллов.



Пример кода для определения номеров

n = 1
a = 11
b = 13
for n in range(1,10):
	print 'student ' + str(n)
	print '\tsyscall index: ' + str(317*n%200)
	i = 0
	print '\ttype '+str(i)+': ' + 'task '+str((a*n+b*i)%4) + '\thook ' + str((a*n+b*i)%2)
	i = 1
	print '\ttype '+str(i)+': ' + 'task '+str((a*n+b*i)%4) + '\thook ' + str((a*n+b*i)%4)
	i = 2
	print '\ttype '+str(i)+': ' + 'task '+str((a*n+b*i)%4) + '\thook ' + str((a*n+b*i)%4)
	i = 3
	print '\ttype '+str(i)+': ' + 'task '+str((a*n+b*i)%4) + '\thook ' + str((a*n+b*i)%2)


Могут быть полезны следующие примеры.
Примеры в каталоге lab\2\examples\syscall демонстрируют работу с таблицей системных вызовов, определение индексов системных вызовов.
lab\3\examples\syscall\hook\NtCreateFile3 - перехват системного вызова NtCreateFile, получение абсолютного пути файла по хендлу.
lab\3\examples\syscall\hook\NtCreateKey - перехват системного вызова NtCreateKey, получение абсолютного пути ключа по хендлу.
lab\5\examples\proclist - получение списка процессов с помощью вызова NtQuerySystemInformation.
lab\6\examples\list_process_thread - работа со списком всех процессов.
lab\6\examples\list_table_handle - работа со списком таблиц хендлов процессов.
lab\7\examples\rootkits\hide_proc - удаление процесса из списка.
lab\7\examples\rootkits\HideFile - подмена адреса IRP-обработчика с кодом IRP_MJ_DIRECTORY_CONTROL драйвера устройства \\NTFS для скрытия файла.
lab\7\examples\rootkits\HideFile_splicing - перехват с помощью сплайсинга IRP-обработчика с кодом IRP_MJ_DIRECTORY_CONTROL драйвера \FileSystem\Ntfs для скрытия файла.
lab\8\examples\KbdFilter - пример подсоединения в стек к драйверу клавиатуры.
lab\8\examples\HideTcp - пример подмены адреса IRP-обработчика сетевого драйвера для скрытия сетевых соединений под Windows XP.
lab\9\examples\HideTcpVista - пример подмены адреса IRP-обработчика сетевого драйвера для скрытия сетевых соединений под Windows Vista+.
lab\10\examples\ndis - примеры работы с интерфейсом NDIS